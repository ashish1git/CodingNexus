generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String                    @id @default(uuid())
  email                    String                    @unique
  password                 String
  role                     String
  moodleId                 String?                   @unique
  isActive                 Boolean                   @default(false)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  adminProfile             Admin?
  attendanceRecords        Attendance[]
  competitionRegistrations CompetitionRegistration[]
  competitionSubmissions   CompetitionSubmission[]
  problemSubmissions       ProblemSubmission[]
  quizAttempts             QuizAttempt[]
  studentProfile           Student?
  tickets                  SupportTicket[]

  @@index([email])
  @@index([moodleId])
}

model Student {
  id              String   @id @default(uuid())
  userId          String   @unique
  name            String
  batch           String
  phone           String?
  profilePhotoUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  rollNo          String?
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([batch])
}

model Admin {
  id          String   @id @default(uuid())
  userId      String   @unique
  name        String
  permissions String   @default("all")
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Note {
  id          String   @id @default(uuid())
  title       String
  description String?
  fileUrl     String
  batch       String
  subject     String?
  uploadedBy  String
  uploadedAt  DateTime @default(now())

  @@index([batch])
  @@index([uploadedAt])
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  message   String
  batch     String
  priority  String   @default("normal")
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batch])
  @@index([createdAt])
}

model Quiz {
  id          String        @id @default(uuid())
  title       String
  description String?
  batch       String
  startTime   DateTime
  endTime     DateTime
  duration    Int
  questions   Json
  isActive    Boolean       @default(true)
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  attempts    QuizAttempt[]

  @@index([batch])
  @@index([startTime])
}

model QuizAttempt {
  id          String    @id @default(uuid())
  quizId      String
  userId      String
  answers     Json
  score       Float
  maxScore    Float
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([quizId, userId])
  @@index([userId])
}

model Attendance {
  id       String   @id @default(uuid())
  userId   String
  date     DateTime
  status   String
  batch    String
  markedBy String
  markedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([batch])
}

model SupportTicket {
  id          String    @id @default(uuid())
  userId      String
  subject     String
  message     String
  status      String    @default("open")
  priority    String    @default("normal")
  response    String?
  respondedBy String?
  respondedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Competition {
  id              String                    @id @default(uuid())
  title           String
  description     String
  category        String                    @default("general")
  difficulty      String
  startTime       DateTime
  endTime         DateTime
  duration        Int
  type            String                    @default("individual")
  prizePool       String?
  maxParticipants Int?
  isActive        Boolean                   @default(true)
  createdBy       String
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  registrations   CompetitionRegistration[]
  submissions     CompetitionSubmission[]
  problems        Problem[]

  @@index([startTime])
  @@index([endTime])
  @@index([isActive])
}

model Problem {
  id            String              @id @default(uuid())
  competitionId String
  title         String
  description   String
  difficulty    String
  points        Int
  orderIndex    Int
  constraints   Json
  examples      Json
  testCases     Json
  timeLimit     Int                 @default(3000)
  memoryLimit   Int                 @default(256)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  functionName  String              @default("solution")
  parameters    Json?
  returnType    String              @default("int")
  starterCode   Json?
  competition   Competition         @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  submissions   ProblemSubmission[]

  @@index([competitionId])
  @@index([orderIndex])
}

model CompetitionRegistration {
  id            String      @id @default(uuid())
  competitionId String
  userId        String
  registeredAt  DateTime    @default(now())
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
}

model CompetitionSubmission {
  id                 String              @id @default(uuid())
  competitionId      String
  userId             String
  submittedAt        DateTime            @default(now())
  totalScore         Int                 @default(0)
  totalTime          Int                 @default(0)
  rank               Int?
  status             String              @default("pending")
  competition        Competition         @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  problemSubmissions ProblemSubmission[]

  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
  @@index([totalScore])
}

model ProblemSubmission {
  id                      String                 @id @default(uuid())
  competitionSubmissionId String
  problemId               String
  userId                  String
  code                    String
  language                String
  score                   Int                    @default(0)
  maxScore                Int
  testsPassed             Int                    @default(0)
  totalTests              Int
  executionTime           Int                    @default(0)
  memoryUsed              Int                    @default(0)
  status                  String                 @default("pending")
  errorMessage            String?
  testResults             Json?
  submittedAt             DateTime               @default(now())
  judgedAt                DateTime?
  manualMarks             Float?
  evaluatorComments       String?
  evaluatedBy             String?
  evaluatedAt             DateTime?
  isEvaluated             Boolean                @default(false)
  competitionSubmission   CompetitionSubmission  @relation(fields: [competitionSubmissionId], references: [id], onDelete: Cascade)
  problem                 Problem                @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user                    User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  evaluations             SubmissionEvaluation[]

  @@index([competitionSubmissionId])
  @@index([problemId])
  @@index([userId])
  @@index([status])
  @@index([isEvaluated])
  @@index([evaluatedBy])
}

model SubmissionEvaluation {
  id               String            @id @default(uuid())
  submissionId     String
  evaluatorId      String
  evaluatorName    String
  evaluatorRole    String
  marks            Float
  comments         String?
  action           String
  previousMarks    Float?
  previousComments String?
  createdAt        DateTime          @default(now())
  ipAddress        String?
  submission       ProblemSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([evaluatorId])
  @@index([createdAt])
  @@index([action])
}
