generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Admin {
  id          String   @id
  userId      String   @unique
  name        String
  permissions String   @default("all")
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Announcement {
  id        String   @id
  title     String
  message   String
  batch     String
  priority  String   @default("normal")
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([batch])
  @@index([createdAt])
}

model Attendance {
  id        String   @id
  userId    String
  date      DateTime
  status    String
  batch     String
  markedBy  String
  markedAt  DateTime @default(now())
  startTime String?
  endTime   String?
  duration  Int?
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([batch])
  @@index([date])
}

model AttendanceRecord {
  id                  String            @id
  sessionId           String
  userId              String
  status              String
  markedAt            DateTime          @default(now())
  markedBy            String
  markedMethod        String            @default("manual")
  latitude            Float?
  longitude           Float?
  distanceFromSession Int?
  locationVerified    Boolean           @default(false)
  ipAddress           String?
  deviceInfo          String?
  deviceFingerprint   String?
  notes               String?
  AttendanceSession   AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  User                User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([markedAt])
  @@index([sessionId])
  @@index([status])
  @@index([userId])
}

model AttendanceSession {
  id               String             @id
  batch            String
  date             DateTime
  sessionType      String             @default("regular")
  startTime        DateTime
  endTime          DateTime?
  location         String?
  latitude         Float?
  longitude        Float?
  maxDistance      Int                @default(100)
  qrCode           String?            @unique
  qrExpiresAt      DateTime?
  isActive         Boolean            @default(true)
  totalStudents    Int                @default(0)
  presentCount     Int                @default(0)
  absentCount      Int                @default(0)
  lateCount        Int                @default(0)
  attendanceRate   Float              @default(0)
  createdBy        String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  AttendanceRecord AttendanceRecord[]

  @@index([batch])
  @@index([createdBy])
  @@index([date])
  @@index([isActive])
}

model Certificate {
  id                 String               @id
  eventName          String
  eventDate          DateTime
  description        String?
  batch              String               @default("All")
  templateType       String               @default("participation")
  isActive           Boolean              @default(true)
  createdBy          String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  CertificateRequest CertificateRequest[]

  @@index([batch])
  @@index([createdAt])
  @@index([isActive])
}

model CertificateRequest {
  id                String      @id
  certificateId     String
  userId            String
  nameOnCertificate String
  status            String      @default("approved")
  downloadCount     Int         @default(0)
  requestedAt       DateTime    @default(now())
  Certificate       Certificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)
  User              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([certificateId, userId])
  @@index([certificateId])
  @@index([status])
  @@index([userId])
}

model Competition {
  id                      String                    @id
  title                   String
  description             String
  category                String                    @default("general")
  difficulty              String
  startTime               DateTime
  endTime                 DateTime
  duration                Int
  type                    String                    @default("individual")
  prizePool               String?
  maxParticipants         Int?
  isActive                Boolean                   @default(true)
  createdBy               String
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  CompetitionRegistration CompetitionRegistration[]
  CompetitionSubmission   CompetitionSubmission[]
  Problem                 Problem[]

  @@index([endTime])
  @@index([isActive])
  @@index([startTime])
}

model CompetitionRegistration {
  id            String      @id
  competitionId String
  userId        String
  registeredAt  DateTime    @default(now())
  Competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
}

model CompetitionSubmission {
  id                String              @id
  competitionId     String
  userId            String
  submittedAt       DateTime            @default(now())
  totalScore        Int                 @default(0)
  totalTime         Int                 @default(0)
  rank              Int?
  status            String              @default("pending")
  Competition       Competition         @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  User              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  ProblemSubmission ProblemSubmission[]

  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([totalScore])
  @@index([userId])
}

model Judge0Queue {
  id                String            @id
  judge0token       String            @unique
  submissionid      String
  userid            String
  problemid         String
  competitionid     String
  status            String            @default("submitted")
  stdout            String?
  stderr            String?
  compilationerror  String?
  testresults       Json?
  executiontime     Int?              @default(0)
  memoryused        Int?              @default(0)
  submittedat       DateTime?         @default(now()) @db.Timestamp(6)
  completedat       DateTime?         @db.Timestamp(6)
  ProblemSubmission ProblemSubmission @relation(fields: [submissionid], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([status])
  @@index([submittedat], map: "Judge0Queue_submittedAt_idx")
  @@index([userid], map: "Judge0Queue_userId_idx")
}

model Note {
  id          String   @id
  title       String
  description String?
  fileUrl     String
  batch       String
  subject     String?
  uploadedBy  String
  uploadedAt  DateTime @default(now())

  @@index([batch])
  @@index([uploadedAt])
}

model Problem {
  id                String              @id
  competitionId     String
  title             String
  description       String
  difficulty        String
  points            Int
  orderIndex        Int
  constraints       Json
  examples          Json
  testCases         Json
  timeLimit         Int                 @default(3000)
  memoryLimit       Int                 @default(256)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  functionName      String              @default("solution")
  parameters        Json?
  returnType        String              @default("int")
  starterCode       Json?
  Competition       Competition         @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  ProblemSubmission ProblemSubmission[]

  @@index([competitionId])
  @@index([orderIndex])
}

model ProblemSubmission {
  id                      String                 @id
  competitionSubmissionId String
  problemId               String
  userId                  String
  code                    String
  language                String
  score                   Int                    @default(0)
  maxScore                Int
  testsPassed             Int                    @default(0)
  totalTests              Int
  executionTime           Int                    @default(0)
  memoryUsed              Int                    @default(0)
  status                  String                 @default("pending")
  errorMessage            String?
  testResults             Json?
  submittedAt             DateTime               @default(now())
  judgedAt                DateTime?
  manualMarks             Float?
  evaluatorComments       String?
  evaluatedBy             String?
  evaluatedAt             DateTime?
  isEvaluated             Boolean                @default(false)
  Judge0Queue             Judge0Queue[]
  CompetitionSubmission   CompetitionSubmission  @relation(fields: [competitionSubmissionId], references: [id], onDelete: Cascade)
  Problem                 Problem                @relation(fields: [problemId], references: [id], onDelete: Cascade)
  User                    User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  SubmissionEvaluation    SubmissionEvaluation[]

  @@index([competitionSubmissionId])
  @@index([evaluatedBy])
  @@index([isEvaluated])
  @@index([problemId])
  @@index([status])
  @@index([userId])
}

model Quiz {
  id          String        @id
  title       String
  description String?
  batch       String
  startTime   DateTime
  endTime     DateTime
  duration    Int
  questions   Json
  isActive    Boolean       @default(true)
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  QuizAttempt QuizAttempt[]

  @@index([batch])
  @@index([startTime])
}

model QuizAttempt {
  id          String    @id
  quizId      String
  userId      String
  answers     Json
  score       Float
  maxScore    Float
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  Quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([quizId, userId])
  @@index([userId])
}

model Student {
  id              String   @id
  userId          String   @unique
  name            String
  batch           String
  phone           String?
  profilePhotoUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  rollNo          String?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([batch])
}

model SubmissionEvaluation {
  id                String            @id
  submissionId      String
  evaluatorId       String
  evaluatorName     String
  evaluatorRole     String
  marks             Float
  comments          String?
  action            String
  previousMarks     Float?
  previousComments  String?
  createdAt         DateTime          @default(now())
  ipAddress         String?
  ProblemSubmission ProblemSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([createdAt])
  @@index([evaluatorId])
  @@index([submissionId])
}

model SupportTicket {
  id          String    @id
  userId      String
  subject     String
  message     String
  status      String    @default("open")
  priority    String    @default("normal")
  response    String?
  respondedBy String?
  respondedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model User {
  id                      String                    @id
  email                   String                    @unique
  password                String
  role                    String
  moodleId                String?                   @unique
  isActive                Boolean                   @default(false)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  Admin                   Admin?
  Attendance              Attendance[]
  AttendanceRecord        AttendanceRecord[]
  CertificateRequest      CertificateRequest[]
  CompetitionRegistration CompetitionRegistration[]
  CompetitionSubmission   CompetitionSubmission[]
  ProblemSubmission       ProblemSubmission[]
  QuizAttempt             QuizAttempt[]
  Student                 Student?
  SupportTicket           SupportTicket[]

  @@index([email])
  @@index([moodleId])
}
