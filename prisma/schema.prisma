generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String                    @id @default(uuid())
  email                    String                    @unique
  password                 String
  role                     String
  moodleId                 String?                   @unique
  isActive                 Boolean                   @default(false)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  adminProfile             Admin?
  attendanceRecords        Attendance[]
  newAttendanceRecords     AttendanceRecord[]
  competitionRegistrations CompetitionRegistration[]
  competitionSubmissions   CompetitionSubmission[]
  problemSubmissions       ProblemSubmission[]
  quizAttempts             QuizAttempt[]
  studentProfile           Student?
  tickets                  SupportTicket[]
  certificateRequests      CertificateRequest[]

  @@index([email])
  @@index([moodleId])
}

model Student {
  id              String   @id @default(uuid())
  userId          String   @unique
  name            String
  batch           String
  phone           String?
  profilePhotoUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  rollNo          String?
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([batch])
}

model Admin {
  id          String   @id @default(uuid())
  userId      String   @unique
  name        String
  permissions String   @default("all")
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Note {
  id          String   @id @default(uuid())
  title       String
  description String?
  fileUrl     String
  batch       String
  subject     String?
  uploadedBy  String
  uploadedAt  DateTime @default(now())

  @@index([batch])
  @@index([uploadedAt])
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  message   String
  batch     String
  priority  String   @default("normal")
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batch])
  @@index([createdAt])
}

model Quiz {
  id          String        @id @default(uuid())
  title       String
  description String?
  batch       String
  startTime   DateTime
  endTime     DateTime
  duration    Int
  questions   Json
  isActive    Boolean       @default(true)
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  attempts    QuizAttempt[]

  @@index([batch])
  @@index([startTime])
}

model QuizAttempt {
  id          String    @id @default(uuid())
  quizId      String
  userId      String
  answers     Json
  score       Float
  maxScore    Float
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([quizId, userId])
  @@index([userId])
}

// Professional Attendance System with Sessions and Analytics
model AttendanceSession {
  id              String              @id @default(uuid())
  batch           String
  date            DateTime
  sessionType     String              @default("regular") // regular, makeup, special
  startTime       DateTime
  endTime         DateTime?
  location        String?
  latitude        Float?              // Session location for geofencing
  longitude       Float?              // Session location for geofencing
  maxDistance     Int                 @default(100) // Max distance in meters for valid attendance
  qrCode          String?             @unique
  qrExpiresAt     DateTime?
  isActive        Boolean             @default(true)
  totalStudents   Int                 @default(0)
  presentCount    Int                 @default(0)
  absentCount     Int                 @default(0)
  lateCount       Int                 @default(0)
  attendanceRate  Float               @default(0)
  createdBy       String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  records         AttendanceRecord[]

  @@index([batch])
  @@index([date])
  @@index([isActive])
  @@index([createdBy])
}

model AttendanceRecord {
  id                  String             @id @default(uuid())
  sessionId           String
  userId              String
  status              String             // present, absent, late, excused
  markedAt            DateTime           @default(now())
  markedBy            String
  markedMethod        String             @default("manual") // manual, qr, biometric, auto
  latitude            Float?
  longitude           Float?
  distanceFromSession Int?               // Distance from session location in meters
  locationVerified    Boolean            @default(false) // Whether location was verified
  ipAddress           String?
  deviceInfo          String?
  deviceFingerprint   String?            // For preventing duplicate devices
  notes               String?
  session             AttendanceSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@index([markedAt])
}

// Legacy attendance model - kept for backward compatibility
model Attendance {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  status    String
  batch     String
  markedBy  String
  markedAt  DateTime @default(now())
  startTime String?
  endTime   String?
  duration  Int?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([batch])
}

model SupportTicket {
  id          String    @id @default(uuid())
  userId      String
  subject     String
  message     String
  status      String    @default("open")
  priority    String    @default("normal")
  response    String?
  respondedBy String?
  respondedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Competition {
  id              String                    @id @default(uuid())
  title           String
  description     String
  category        String                    @default("general")
  difficulty      String
  startTime       DateTime
  endTime         DateTime
  duration        Int
  type            String                    @default("individual")
  prizePool       String?
  maxParticipants Int?
  isActive        Boolean                   @default(true)
  createdBy       String
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  registrations   CompetitionRegistration[]
  submissions     CompetitionSubmission[]
  problems        Problem[]

  @@index([startTime])
  @@index([endTime])
  @@index([isActive])
}

model Problem {
  id            String              @id @default(uuid())
  competitionId String
  title         String
  description   String
  difficulty    String
  points        Int
  orderIndex    Int
  constraints   Json
  examples      Json
  testCases     Json
  timeLimit     Int                 @default(3000)
  memoryLimit   Int                 @default(256)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  functionName  String              @default("solution")
  parameters    Json?
  returnType    String              @default("int")
  starterCode   Json?
  competition   Competition         @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  submissions   ProblemSubmission[]

  @@index([competitionId])
  @@index([orderIndex])
}

model CompetitionRegistration {
  id            String      @id @default(uuid())
  competitionId String
  userId        String
  registeredAt  DateTime    @default(now())
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
}

model CompetitionSubmission {
  id                 String              @id @default(uuid())
  competitionId      String
  userId             String
  submittedAt        DateTime            @default(now())
  totalScore         Int                 @default(0)
  totalTime          Int                 @default(0)
  rank               Int?
  status             String              @default("pending")
  competition        Competition         @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  problemSubmissions ProblemSubmission[]

  @@unique([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
  @@index([totalScore])
}

model ProblemSubmission {
  id                      String                 @id @default(uuid())
  competitionSubmissionId String
  problemId               String
  userId                  String
  code                    String
  language                String
  score                   Int                    @default(0)
  maxScore                Int
  testsPassed             Int                    @default(0)
  totalTests              Int
  executionTime           Int                    @default(0)
  memoryUsed              Int                    @default(0)
  status                  String                 @default("pending")
  errorMessage            String?
  testResults             Json?
  submittedAt             DateTime               @default(now())
  judgedAt                DateTime?
  manualMarks             Float?
  evaluatorComments       String?
  evaluatedBy             String?
  evaluatedAt             DateTime?
  isEvaluated             Boolean                @default(false)
  competitionSubmission   CompetitionSubmission  @relation(fields: [competitionSubmissionId], references: [id], onDelete: Cascade)
  problem                 Problem                @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user                    User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  evaluations             SubmissionEvaluation[]

  @@index([competitionSubmissionId])
  @@index([problemId])
  @@index([userId])
  @@index([status])
  @@index([isEvaluated])
  @@index([evaluatedBy])
}

model SubmissionEvaluation {
  id               String            @id @default(uuid())
  submissionId     String
  evaluatorId      String
  evaluatorName    String
  evaluatorRole    String
  marks            Float
  comments         String?
  action           String
  previousMarks    Float?
  previousComments String?
  createdAt        DateTime          @default(now())
  ipAddress        String?
  submission       ProblemSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([evaluatorId])
  @@index([createdAt])
  @@index([action])
}

// Certificate System
model Certificate {
  id            String               @id @default(uuid())
  eventName     String
  eventDate     DateTime
  description   String?
  batch         String               @default("All")
  templateType  String               @default("participation") // participation, achievement, completion
  isActive      Boolean              @default(true)
  createdBy     String
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  requests      CertificateRequest[]

  @@index([batch])
  @@index([isActive])
  @@index([createdAt])
}

model CertificateRequest {
  id                String      @id @default(uuid())
  certificateId     String
  userId            String
  nameOnCertificate String
  status            String      @default("approved") // approved (auto-approved for now)
  downloadCount     Int         @default(0)
  requestedAt       DateTime    @default(now())
  certificate       Certificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([certificateId, userId])
  @@index([userId])
  @@index([certificateId])
  @@index([status])
}

// Event Management System - For external participants (non-batch students)
model Event {
  id                   String                @id @default(uuid())
  title                String
  description          String?
  eventType            String                @default("workshop") // workshop, hackathon, seminar, competition, webinar
  eventDate            DateTime
  eventEndDate         DateTime?
  venue                String?
  posterUrl            String?               // Cloudinary URL for event poster
  maxParticipants      Int                   @default(100)
  registrationDeadline DateTime
  status               String                @default("upcoming") // upcoming, ongoing, completed, cancelled
  isActive             Boolean               @default(true)
  batch                String?               // Optional: If event is batch-specific
  createdBy            String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  registrations        EventRegistration[]
  certificates         EventCertificate[]
  accessControls       EventAccessControl[]
  announcementsEvent   EventAnnouncement[]
  emailLogs            EventEmailLog[]
  quizzes              EventQuiz[]

  @@index([status])
  @@index([eventDate])
  @@index([isActive])
  @@index([createdBy])
}

model EventParticipant {
  id                     String              @id @default(uuid())
  name                   String
  email                  String              @unique
  phone                  String
  year                   String?             // FE, SE, TE, BE
  branch                 String?             // Computer, IT, EXTC, etc.
  division               String?             // A, B, C
  collegeName            String?
  password               String              // Hashed password
  isEmailVerified        Boolean             @default(false)
  emailVerificationToken String?             @unique
  userType               String              @default("event_guest") // Always event_guest
  isActive               Boolean             @default(true)
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  registrations          EventRegistration[]
  certificates           EventCertificate[]
  emailLogs              EventEmailLog[]
  quizAttempts           EventQuizAttempt[]

  @@index([email])
  @@index([userType])
  @@index([isEmailVerified])
}

model EventRegistration {
  id                 String             @id @default(uuid())
  eventId            String
  participantId      String
  registrationDate   DateTime           @default(now())
  attendanceMarked   Boolean            @default(false)
  attendanceTime     DateTime?
  certificateGenerated Boolean          @default(false)
  certificateId      String?
  registrationStatus String             @default("confirmed") // confirmed, waitlist, cancelled
  event              Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participant        EventParticipant   @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([eventId, participantId])
  @@index([eventId])
  @@index([participantId])
  @@index([registrationStatus])
}

model EventCertificate {
  id                String           @id @default(uuid())
  eventId           String
  participantId     String
  registrationId    String?
  certificateNumber String           @unique
  certificateUrl    String?          // PDF URL on Cloudinary
  issueDate         DateTime         @default(now())
  templateType      String           @default("participation") // participation, winner, runner_up, excellence
  verified          Boolean          @default(true)
  event             Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participant       EventParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([participantId])
  @@index([eventId])
  @@index([certificateNumber])
}

model EventAccessControl {
  id              String    @id @default(uuid())
  eventId         String
  resourceType    String    // quiz, notes, assignments, dashboard, competition
  resourceId      String?   // ID of specific resource
  accessAllowed   Boolean   @default(true)
  accessStartTime DateTime?
  accessEndTime   DateTime?
  createdAt       DateTime  @default(now())
  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([resourceType])
}

model EventEmailLog {
  id            String            @id @default(uuid())
  eventId       String
  participantId String
  emailType     String            // registration_confirmation, event_reminder, event_update, certificate, event_start, event_end
  sentAt        DateTime          @default(now())
  emailStatus   String            @default("sent") // sent, failed, pending
  subject       String
  message       String
  event         Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participant   EventParticipant  @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([participantId])
  @@index([emailType])
}

model EventAnnouncement {
  id               String    @id @default(uuid())
  eventId          String
  title            String
  message          String
  announcementType String    @default("info") // info, important, update, reminder
  createdAt        DateTime  @default(now())
  createdBy        String
  event            Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([createdAt])
}

model EventQuiz {
  id          String              @id @default(uuid())
  eventId     String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  duration    Int                 // in minutes
  questions   Json                // Array of {question, type, options, correctAnswer, codeSnippet?}
  isActive    Boolean             @default(true)
  createdBy   String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  event       Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  attempts    EventQuizAttempt[]

  @@index([eventId])
  @@index([startTime])
  @@index([isActive])
}

model EventQuizAttempt {
  id            String           @id @default(uuid())
  quizId        String
  participantId String
  answers       Json
  score         Float
  maxScore      Float
  startedAt     DateTime         @default(now())
  submittedAt   DateTime?
  quiz          EventQuiz        @relation(fields: [quizId], references: [id], onDelete: Cascade)
  participant   EventParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([quizId, participantId])
  @@index([participantId])
  @@index([quizId])
}